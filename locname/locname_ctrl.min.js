function showMsgError(e,o){e.alerts.push({type:"danger",msg:o})}vLocNameModule.controller("LocNameController",["$scope","$rootScope","$http","$translate","LocNameStateService","wStorageService",function(e,o,a,n,t,l){"use strict";function s(o,a){l.put("cLat",o),l.put("cLng",a),e.map={center:{latitude:o,longitude:a},zoom:8},e.options={scrollwheel:!1},e.marker={id:0,coords:{latitude:o,longitude:a},options:{draggable:!1},events:{dragend:function(){}}}}function m(){var o={enableHighAccuracy:!0,timeout:5e3,maximumAge:0};u=l.get("cLat"),A=l.get("cLng"),null==u&&null==A?navigator.geolocation?navigator.geolocation.getCurrentPosition(d,r,o):(s(40.437827,-3.679537),e.alerts.push({type:"danger",msg:n.instant("LOCNAME.ERROR_CURRENT_LOC")}),e.lnkVisible="false"):s(u,A)}function g(){var a=parseInt(l.get("nq"));if(isNaN(a))l.put("nq",0..toString());else{if(a>o.MAX_QUERIES)return e.alerts=[],e.alerts.push({type:"danger",msg:n.instant("UADM.MAX_USER")}),e.lnkVisible="true",!1;l.put("nq",(a+1).toString())}return!0}function i(){e.geonameID="---",e.geonameName="---",e.geonameLat="---",e.geonameLng="---",e.geonameUACode1="---",e.geonameUACode2="---",e.geonameUACode3="---",e.geonameUACode4="---",e.geonameUACode5="---",e.geonameUALevel="",e.geonameUACode=""}function d(e){u=e.coords.latitude,A=e.coords.longitude,s(u,A)}function r(){s(40.437827,-3.679537)}var c={},u=l.get("cLat"),A=l.get("cLng"),L=[];m(),s(40.437827,-3.679537),e.showGeonameButton=!1,e.autocompleteOptions={types:["geocode"]},e.initialTxtGoogle="",e.latGoogle="[ ]",e.lngGoogle="[ ]",i();var p=l.get("lg");null===p?(n.use("es_ES"),l.put("lg","es_ES"),p="es_ES"):n.use(p);var C="geonamesListNO",N="geonamesListOK";e.locListClassAdd=C,e.txtLocalizaciones=n.instant("LOCNAME.NO_AVA_LOCATIONS"),e.alerts=[],l.put("dun",o.USER),e.userNoSaved=!1;var f=o.USER;e.alerts.push({type:"info",msg:n.instant("LOCNAME.DEMO_USER")}),e.lnkVisible="true",window.document.title="es_ES"===p?"Localización por Nombre":"Places Location",o.$on("$locationChangeStart",function(o,a,n){if(-1!=n.indexOf("locname")){var l={};l.googleTxt=c.name,l.latGoogle=e.latGoogle,l.lngGoogle=e.lngGoogle,l.map=e.map,l.marker=e.marker,l.locationsList=e.places_list,l.placesList_model=e.placesList_model,l.tblGeonameID=e.geonameID,l.tblName=e.geonameName,l.tblLat=e.geonameLat,l.tblLng=e.geonameLng,l.tblNAdm1=e.geonameUACode1,l.tblNAdm2=e.geonameUACode2,l.tblNAdm3=e.geonameUACode3,l.tblNAdm4=e.geonameUACode4,l.tblNAdm5=e.geonameUACode5,l.locListClassAdd=e.locListClassAdd,l.txtLocalizaciones=e.txtLocalizaciones,t.saveData(l)}if(-1!=a.indexOf("locname")){var s=t.readData();e.initialTxtGoogle=s.googleTxt,c.name=s.googleTxt,e.latGoogle=s.latGoogle,e.lngGoogle=s.lngGoogle,e.map=s.map,e.marker=s.marker,e.places_list=s.locationsList,e.placesList_model=s.placesList_model,e.geonameID=s.tblGeonameID,e.geonameName=s.tblName,e.geonameLat=s.tblLat,e.geonameLng=s.tblLng,e.geonameUACode1=s.tblNAdm1,e.geonameUACode2=s.tblNAdm2,e.geonameUACode3=s.tblNAdm3,e.geonameUACode4=s.tblNAdm4,e.geonameUACode5=s.tblNAdm5,e.locListClassAdd=s.locListClassAdd,e.txtLocalizaciones=s.txtLocalizaciones}});e.$on("gmPlacesAutocomplete::placeChanged",function(){if("undefined"!=typeof e.autocompleteModel){var o=e.autocompleteModel.getPlace();if(o.geometry){i();var a=o.geometry.location;e.latGoogle=Number(a.lat()).toFixed(6),e.lngGoogle=Number(a.lng()).toFixed(6),e.map.center.latitude=a.lat(),e.map.center.longitude=a.lng(),e.marker.coords.latitude=a.lat(),e.marker.coords.longitude=a.lng(),c.name=o.formatted_address,c.country="",c.uAdm1="",c.uAdm2="",c.uAdm3="";for(var n=o.address_components,t=n.length,l=0,s=0;t>s;s++)if(l=n[s].types.length,l>0)for(var m=n[s].types,g=0;l>g;g++)switch(m[g]){case"administrative_area_level_1":c.uAdm1=n[s].long_name;break;case"administrative_area_level_2":c.uAdm2=n[s].long_name;break;case"administrative_area_level_3":c.uAdm3=n[s].long_name;break;case"country":c.country=n[s].short_name}e.showGeonameButton=!0,e.$apply(),e.searchGeoname()}else e.latGoogle="NO SE LOCALIZA",e.lngGoogle="NO SE LOCALIZA",e.$apply()}});e.searchGeoname=function(){var o="http://api.geonames.org/searchJSON?q=",t="&username="+f,l="&featureClass=A&featureClass=L&featureClass=P",s=c.name.split(","),m="";m=o+c.name+"&name="+s[0]+"&adminName1="+c.uAdm1+"&adminName2="+c.uAdm2+"&adminName3="+c.uAdm3+"&country="+c.country+l+t,g()&&a.get(m).success(function(o){if(null!==o.status&&void 0!==o.status)return showMsgError(e,n.instant("UADM.ERROR_ACCESS")),void(e.lnkVisible="false");if(L.splice(0,L.length),o.totalResultsCount>0){for(var a=0;a<o.totalResultsCount;a++){for(var t=!1,l=0;l<L.length;l++)if(L[l].name==o.geonames[a].name){t=!0;break}t||L.push({id:o.geonames[a].geonameId,name:o.geonames[a].name})}e.locListClassAdd=N,e.txtLocalizaciones=n.instant("LOCNAME.SEL_LOCATION")}else L.push({id:0,name:"No se han encontrado"}),e.locListClassAdd=C,e.txtLocalizaciones=n.instant("LOCNAME.NO_AVA_LOCATIONS"),i();e.places_list=L}).error(function(){showMsgError(e,n.instant("UADM.ERROR_ACCESS")),e.lnkVisible="false"})},e.searchLatLongGeoname=function(){var o="http://api.geonames.org/findNearbyPlaceNameJSON?",n="http://api.geonames.org/getJSON?",t="&username="+f,l=o+"lat="+e.latGoogle+"&lng="+e.lngGoogle+t;g()&&a.get(l).success(function(o){console.log(l),console.log(o),e.geonameID=o.geonames[0].geonameId,e.geonameName=o.geonames[0].name,e.geonameLat=o.geonames[0].lat,e.geonameLng=o.geonames[0].lng,l=n+"id="+e.geonameID+t,a.get(l).success(function(o){e.geonameUACode1=o.adminCode1,e.geonameUACode2=o.adminCode2,e.geonameUACode3=o.adminCode3,e.geonameUACode4=o.adminCode4,e.geonameUACode5=o.adminCode5,e.map.center.latitude=e.geonameLat,e.map.center.longitude=e.geonameLng,e.marker.coords.latitude=e.geonameLat,e.marker.coords.longitude=e.geonameLng})})},e.searchGeocoderGoogle=function(){var e="http://maps.googleapis.com/maps/api/geocode/json?address=",o=e+c.name+"&sensor=false";a.get(o).success(function(){})},e.getGeonameByID=function(){var o="http://api.geonames.org/getJSON?geonameId=",n="&username="+f,t=o+e.placesList_model.id+n;g()&&a.get(t).success(function(o){e.geonameID=o.geonameId,e.geonameName=o.name,e.geonameLat=o.lat,e.geonameLng=o.lng,e.geonameUACode1=o.adminCode1,e.geonameUACode2=o.adminCode2,e.geonameUACode3=o.adminCode3,e.geonameUACode4=o.adminCode4,e.geonameUACode5=o.adminCode5,e.map.center.latitude=e.geonameLat,e.map.center.longitude=e.geonameLng,e.marker.coords.latitude=e.geonameLat,e.marker.coords.longitude=e.geonameLng})},o.$on("$translateChangeSuccess",function(){var o=l.get("lg");window.document.title="es_ES"===o?"Places location":"Localización por Nombre",e.alerts=[],e.alerts.push({type:"info",msg:n.instant("LOCNAME.DEMO_USER")}),e.lnkVisible="true"}),e.deleteTxtGoogle=function(){var o=document.getElementById("frmLocName");o.value="",e.initialTxtGoogle="",m(),e.latGoogle="[ ]",e.lngGoogle="[ ]",i(),e.places_list={},e.txtLocalizaciones=n.instant("LOCNAME.NO_AVA_LOCATIONS"),e.locListClassAdd=C}}]);